---
title: 看门狗的简单理解
date: 2025/02/27 18:28:34
author: lele
tags:
  - STM32
categories:
---
**看门狗**（Watchdog）是嵌入式系统中一种重要的**硬件或软件机制**，用于检测和恢复系统故障，确保系统在异常情况下能够自动恢复正常运行。它的工作原理类似于现实生活中的“看门狗”：如果主人（系统）长时间不“喂狗”（重置看门狗），看门狗就会认为系统出现故障，并采取行动（如复位系统）。

---

### **一、看门狗的作用**
1. **故障检测**：  
   - 当系统由于软件错误、死循环或外部干扰导致“卡死”时，看门狗能够检测到这种异常状态。
2. **系统恢复**：  
   - 看门狗会在检测到故障后，自动复位系统，使其重新启动并恢复正常运行。
3. **提高可靠性**：  
   - 在工业控制、汽车电子、医疗设备等对可靠性要求高的场景中，看门狗是必不可少的。

---

### **二、看门狗的工作原理**
1. **计数器机制**：  
   - 看门狗内部有一个计数器，系统需要定期“喂狗”（即重置计数器）。
   - 如果系统正常，计数器会被定期清零，不会触发复位。
   - 如果系统异常（如卡死），计数器会溢出，触发复位操作。
2. **复位操作**：  
   - 当计数器溢出时，看门狗会强制复位整个系统，类似于按下重启按钮。

---

### **三、看门狗的类型**
1. **独立看门狗（IWDG, Independent Watchdog）**  
   - **特点**：  
     - 完全由硬件实现，独立于系统时钟。  
     - 即使系统时钟失效，也能正常工作。  
   - **应用场景**：  
     - 对可靠性要求极高的场景（如汽车电子、工业控制）。  
   - **配置**：  
     - 通过设置计数器的初始值和重载值来调整超时时间。

2. **窗口看门狗（WWDG, Window Watchdog）**  
   - **特点**：  
     - 需要在一个特定的“时间窗口”内喂狗，过早或过晚喂狗都会触发复位。  
     - 提供更严格的监控机制。  
   - **应用场景**：  
     - 对系统响应时间要求严格的场景（如实时控制系统）。  
   - **配置**：  
     - 设置窗口的上限和下限时间。

---

### **四、看门狗的配置（以STM32为例）**
#### **1. 独立看门狗（IWDG）配置**
```c
#include "stm32f1xx_hal.h"

void IWDG_Init(void) {
  // 启用独立看门狗
  __HAL_RCC_WWDG_CLK_ENABLE();

  // 设置看门狗超时时间
  IWDG->KR = 0xCCCC;  // 启动看门狗
  IWDG->KR = 0x5555;  // 允许写寄存器
  IWDG->PR = 0x06;    // 预分频器（设置计数频率）
  IWDG->RLR = 0xFFF;  // 重载值（设置超时时间）
  IWDG->KR = 0xAAAA;  // 喂狗（重置计数器）
}

void IWDG_Feed(void) {
  IWDG->KR = 0xAAAA;  // 喂狗
}
```

#### **2. 窗口看门狗（WWDG）配置**
```c
#include "stm32f1xx_hal.h"

void WWDG_Init(void) {
  // 启用窗口看门狗
  __HAL_RCC_WWDG_CLK_ENABLE();

  // 设置窗口看门狗参数
  WWDG->CFR = 0x7F;  // 设置窗口上限
  WWDG->CR = 0xFF;   // 设置计数器初始值
  WWDG->CR |= WWDG_CR_WDGA;  // 启用看门狗
}

void WWDG_Feed(void) {
  WWDG->CR = 0xFF;  // 喂狗
}
```

---

### **五、看门狗的使用场景**
1. **工业控制**：  
   - 在PLC（可编程逻辑控制器）中，看门狗用于检测系统故障并自动复位。
2. **汽车电子**：  
   - 在汽车电子控制单元（ECU）中，看门狗确保系统在异常情况下能够恢复。
3. **医疗设备**：  
   - 在医疗设备中，看门狗提高系统的可靠性和安全性。
4. **消费电子**：  
   - 在智能家居、智能穿戴设备中，看门狗防止系统卡死。

---

### **六、注意事项**
1. **喂狗时间**：  
   - 喂狗时间必须小于看门狗的超时时间，否则会触发复位。
2. **调试模式**：  
   - 在调试模式下，看门狗可能会影响调试过程，需根据需求禁用或调整。
3. **系统设计**：  
   - 在设计系统时，确保看门狗的复位不会导致数据丢失或设备损坏。

---

### **总结**
看门狗是嵌入式系统中的“守护者”，能够检测系统故障并自动恢复，显著提高系统的可靠性和稳定性。根据具体需求，可以选择独立看门狗或窗口看门狗，并合理配置其超时时间和喂狗机制。